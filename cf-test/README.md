# Setting up test instance

```
cd terraform
make up
```

SSH to the instance then run:

```
sudo cloud-init status --wait
```

Wait until the cloud-init stuff has finished

Then scp `vault_selinux-1.1-1.el7.noarch.rpm` to the instance from this folder

Then from the instance:

```
sudo rpm -ivh vault_selinux-1.1-1.el7.noarch.rpm
```

You can check that the policy has applied properly by checking appropriate vault_t contexts in:

```
ls -alZ /opt/vault
ls -alZ /var/log/vault
ls -alZ /usr/sbin/vault
ls -alZ /etc/vault.d
```

You should then be able to start the vault server on the instance:

```
sudo systemctl start vault.service
```

From the centos user you can:
```
export VAULT_ADDR=http://127.0.0.1:8200
vault status
```

Hopefully, if you tail the audit log you shouldn't see AVC errors for vault:

```
sudo tail -f /var/log/audit/audit.log | grep vault
```

After you've initialized and unsealed vault you can also enable the audit engine to write to /var/log/vault/vault.log

```
vault audit enable file file_path=/var/log/vault/vault.log
```

Don't forget to tear down your infra after:

```
make down
```

From the terraform folder.

# Editing the source

The source is available in `vault_selinux-1.1-src` folder, you will probably want to shift this up to the instance too.

The file context mappings are in `vault.fc` - the interfaces are in `vault.if` and the main policy is in `vault.te`.

The `vault.sh` is used to deploy and bundle the policy into an rpm file. This is the main way to update the policy on the system, and was generated with a `sepolicy generate --init -n vault /usr/sbin/vault`

The `vault_selinux.spec` is also generated by the above, and is used to create the RPM.

If you update the fc, if or te files, you can then run `sh ./vault.sh` to re-deploy, then monitor audit log for errors.

If you want to then dynamically update the te file with changes detected in the logs you can run `sh ./vault.sh --update`

If you want to remove the policy then you can run a `sudo semodule -r vault`

# Updating the rpm

You'll need to shift the `vault_selinux-1.1-src` onto a Centos instance with the sepolicy pre-requisites (if you `make up` in the `terraform` folder that's what you get).

After you `sudo sh ./vault.sh` it will install the policy, plus, it will create a folder called `noarch` - and the RPM file will be in there. Any time you make changes to the `vault.te` file (or other sepolicy files), and re-run `sudo sh ./vault.sh` it will generate a new RPM file.
