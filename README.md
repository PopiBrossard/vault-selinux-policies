# vault-selinux-policies

**NOT READY FOR USE AS OF 28-JULY-2020**

A set of base SELinux policies, and CircleCI to _try_ and package the policies into RPMs for Vault currently under development.

## Overview

This repo intends to be a draft setup for holding the raw SELinux policies files, the packaging scripts _and_ validation scripts to package and validate via CircleCI. This repo mirrors the patterns from https://github.com/hashicorp/linux-packaging.

### Layout

In the [products/vault_selinux/](products/vault_selinux/) folder exists the raw SELinux config files, plus [package.sh](products/vault_selinux/package.sh). This script gets executed by [circle](.circleci/config.yml).

In the [products/vault_selinux/](products/vault_selinux/) folder exists the [ci/validate.sh](products/vault_selinux/ci/validate.sh) script. This gets executed by [circle](.circleci/config.yml) too.

## Editing the source

To edit the underlying SELinux policies, edit the `vault*` files in [products/vault_selinux/](products/vault_selinux/).

The file context mappings are in `vault.fc` - the interfaces are in `vault.if` and the main policy is in `vault.te`.

The `vault.sh` is used to deploy and bundle the policy into an rpm file. This is the main way to update the policy on the system, and was generated with a `sepolicy generate --init -n vault /usr/sbin/vault`

The `vault_selinux.spec` is also generated by the above, and is used to create the RPM. Although this file has been modified.

## Updating the rpm

Pushing this repo to master will kick off the CI job: https://app.circleci.com/pipelines/github/hashicorp/vault-selinux-policies?branch=master

## Setting up test instances

To test that the RPM packages are installable the `terraform` directory contains logic to spin up 2 instances:
- A Fedora EC2 instance
- A CentOS EC2 instance

```
cd terraform
make up
```

SSH to the instances then run:

```
sudo cloud-init status --wait
```

Wait until the cloud-init stuff has finished

Install Vault as per instructions from: https://learn.hashicorp.com/tutorials/vault/getting-started-install?in=vault/getting-started following the Linux `CentOS/RHEL` or `Fedora` commands

Then scp `vault_selinux-1.1-1.el7.noarch.rpm` to the instances from this folder.

Currently, the rpm is being built in CircleCI [here](https://app.circleci.com/pipelines/github/hashicorp/vault-selinux-policies?branch=master), and saved as an artifact in the package step.

Then from the instances (or dnf/yum install):

```
sudo rpm -ivh vault_selinux-1.1-1.el7.noarch.rpm
```

You can check that the policy has applied properly by checking appropriate vault_t contexts in:

```
ls -alZ /opt/vault
ls -alZ /var/log/vault
ls -alZ /usr/sbin/vault
ls -alZ /etc/vault.d
```

Or by running `semanage` commands, similar to our [validation](products/vault_selinux/ci/validate.sh) logic:

```
sudo semanage module -l | grep vault
sudo semanage port -l | grep vault_cluster_port_t
```

You should then be able to start the vault server on the instance:

```
sudo systemctl start vault.service
```

From the centos user you can:
```
export VAULT_ADDR=http://127.0.0.1:8200
vault status
```

Hopefully, if you tail the audit log you shouldn't see AVC errors for vault:

```
sudo tail -f /var/log/audit/audit.log | grep vault
```

After you've initialized and unsealed vault you can also enable the audit engine to write to /var/log/vault/vault.log

```
vault audit enable file file_path=/var/log/vault/vault.log
```

Don't forget to tear down your infra after:

```
make down
```

From the terraform folder.

# References blogs etc

I did a _lot_ of googling to get my head around this, and realize I have a bunch of tabs open, so I'll try and capture my open tabs here:

* Red Hat's What Is SELinux https://www.redhat.com/en/topics/linux/what-is-selinux
* Sysadmin's guide to selinux https://opensource.com/article/18/7/sysadmin-guide-selinux
* How to generate a new initial policy using sepolicy-generate https://mgrepl.wordpress.com/2015/05/20/how-to-create-a-new-initial-policy-using-sepolicy-generate-tool/
* Fun with selinux presentation: https://mgrepl.fedorapeople.org/PolicyCourse/writingSELinuxpolicy_MUNI.pdf
* Selinux labels: https://wiki.gentoo.org/wiki/SELinux/Labels
* Using sesearch https://www.server-world.info/en/note?os=CentOS_7&p=selinux&f=11
* Basic policy editing examples https://www.linuxtopia.org/online_books/writing_SELinux_policy_guide/policy_editing_examples_12.html
* Customizing selinux policies https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/5/html/deployment_guide/sec-sel-policy-customizing
* Adjusting selinux policies https://download.geo.drweb.com/pub/drweb/unix/doc/HTML/ControlCenter/en/dw_8_install_selinux.htm
* I cloned the following two repos to find what certain interfaces, macros and methods did. https://github.com/SELinuxProject/refpolicy & https://github.com/fedora-selinux/selinux-policy
* Troubleshooting selinux problems https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/using_selinux/troubleshooting-problems-related-to-selinux_using-selinux
* Linux restorecon command examples https://www.thegeekstuff.com/2017/05/restorecon-examples/
* Walk through of the INN policy https://www.linuxtopia.org/online_books/writing_SELinux_policy_guide/case_study_13.html 

